<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probability Distribution Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .quiz-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }
        h2 {
            color: #0056b3;
            margin-bottom: 20px;
        }
        .question {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .option-item label {
            flex: 0 0 120px; /* Fixed width for labels */
            margin-right: 15px;
            font-weight: normal;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .score-display {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #e9ecef;
            display: none; /* Hidden by default */
        }
        .score-display p {
            margin: 5px 0;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
        .quiz-question-block {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .quiz-question-block h4 {
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .score-display {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #e9ecef;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <h2>Guess the Probability Distribution</h2>
        <div id="quiz-questions-container">
            <!-- All questions will be dynamically loaded here -->
        </div>
    </div>

    <script>
        let quizData = []; // Will store all quiz questions

        document.addEventListener('DOMContentLoaded', () => {
            fetch('quiz_data.json')
                .then(response => response.json())
                .then(data => {
                    quizData = data;
                    loadAllQuizQuestions();
                })
                .catch(error => {
                    console.error('Error loading quiz data:', error);
                    document.getElementById('quiz-questions-container').innerHTML = '<p>Error loading quiz. Please try again later.</p>';
                });
        });

        function loadAllQuizQuestions() {
            const quizQuestionsContainer = document.getElementById('quiz-questions-container');
            quizQuestionsContainer.innerHTML = ''; // Clear previous content

            quizData.forEach((questionData, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('quiz-question-block');
                questionDiv.innerHTML = `
                    <div class="question">
                        ${qIndex + 1}. ${questionData.question}
                    </div>
                    <div class="options" id="options-container-${qIndex}">
                        <!-- Options will be dynamically loaded here for each question -->
                    </div>
                    <div class="error-message" id="error-message-${qIndex}" style="display:none;"></div>
                    <button onclick="submitGuess(${qIndex})">Submit Guess</button>
                    <div class="score-display" id="score-display-${qIndex}" style="display:none;">
                        <h4>Results for Question ${qIndex + 1}</h4>
                        <p>Your Guess: <span id="your-guess-${qIndex}"></span></p>
                        <p>Correct Distribution: <span id="correct-distribution-${qIndex}"></span></p>
                        <p>Your Score (Higher is better): <span id="score-value-${qIndex}"></span></p>
                    </div>
                `;
                quizQuestionsContainer.appendChild(questionDiv);

                const optionsContainer = document.getElementById(`options-container-${qIndex}`);
                questionData.options.forEach((option, i) => {
                    const optionItem = document.createElement('div');
                    optionItem.classList.add('option-item');
                    optionItem.innerHTML = `
                        <label for="slider-${qIndex}-${i}">${option}:</label>
                        <div>
                            <input type="range" id="slider-${qIndex}-${i}" data-question-index="${qIndex}" data-option-index="${i}" min="0" max="100" step="0.1" value="0" list="tickmarks-${qIndex}-${i}">
                            <span id="value-${qIndex}-${i}">0.00%</span>
                            <datalist id="tickmarks-${qIndex}-${i}"></datalist>
                        </div>
                    `;
                    optionsContainer.appendChild(optionItem);
                });

                // Populate datalists with correct answer tickmarks
                const correctDistribution = questionData.correctDistribution;
                correctDistribution.forEach((correctProb, i) => {
                    const datalist = document.getElementById(`tickmarks-${qIndex}-${i}`);
                    if (datalist) {
                        const option = document.createElement('option');
                        option.value = (correctProb * 100).toFixed(1); // Convert to percentage for slider value
                        datalist.appendChild(option);
                    }
                });
            });

            // Attach event listeners to all sliders after they are created
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                slider.oninput = function() {
                    const qIndex = parseInt(this.dataset.questionIndex);
                    const oIndex = parseInt(this.dataset.optionIndex);
                    updateSliderValues(qIndex, oIndex);
                };
            });

            // Initial update for all sliders
            quizData.forEach((_, qIndex) => updateSliderValues(qIndex, -1));
        }

        function updateSliderValues(questionIndex, changedOptionIndex) {
            const slidersForQuestion = document.querySelectorAll(`input[type="range"][data-question-index="${questionIndex}"]`);
            const valuesForQuestion = document.querySelectorAll(`span[id^="value-${questionIndex}-"]`);
            const slidersArray = Array.from(slidersForQuestion);

            if (slidersArray.length === 0) return;

            // Handle initial load: distribute 100% evenly among all sliders
            if (changedOptionIndex === -1) {
                const initialValue = 100 / slidersArray.length;
                slidersArray.forEach(slider => {
                    slider.value = initialValue.toFixed(1);
                });
                // Ensure the sum is exactly 100 after initial distribution
                let currentSum = slidersArray.reduce((acc, slider) => acc + parseFloat(slider.value), 0);
                if (Math.abs(currentSum - 100) > 0.01 && slidersArray.length > 0) {
                    slidersArray[slidersArray.length - 1].value = (parseFloat(slidersArray[slidersArray.length - 1].value) + (100 - currentSum)).toFixed(1);
                }
            }

            // If a specific slider was changed by the user
            if (changedOptionIndex !== -1) {
                let changedSlider = slidersArray[changedOptionIndex];
                let changedValue = parseFloat(changedSlider.value);

                // Calculate the sum of all other sliders
                let sumOfOtherSliders = 0;
                slidersArray.forEach((slider, i) => {
                    if (i !== changedOptionIndex) {
                        sumOfOtherSliders += parseFloat(slider.value);
                    }
                });

                // Calculate the target sum for the other sliders
                let targetSumForOthers = 100 - changedValue;

                // Adjust other sliders proportionally
                if (sumOfOtherSliders > 0) {
                    let scaleFactor = targetSumForOthers / sumOfOtherSliders;
                    slidersArray.forEach((slider, i) => {
                        if (i !== changedOptionIndex) {
                            let newValue = parseFloat(slider.value) * scaleFactor;
                            slider.value = Math.max(0, Math.min(100, newValue)).toFixed(1);
                        }
                    });
                } else if (targetSumForOthers > 0 && slidersArray.length > 1) {
                    // If all other sliders were 0, and we need to distribute targetSumForOthers
                    // Distribute evenly among them
                    let numOtherSliders = slidersArray.length - 1;
                    let valuePerOtherSlider = targetSumForOthers / numOtherSliders;
                    slidersArray.forEach((slider, i) => {
                        if (i !== changedOptionIndex) {
                            slider.value = Math.max(0, Math.min(100, valuePerOtherSlider)).toFixed(1);
                        }
                    });
                }
            }

            // Final pass to ensure sum is exactly 100% due to floating point inaccuracies
            let finalSum = 0;
            slidersArray.forEach(slider => {
                finalSum += parseFloat(slider.value);
            });

            if (Math.abs(finalSum - 100) > 0.01 && slidersArray.length > 0) {
                let lastSlider = slidersArray[slidersArray.length - 1];
                let lastSliderValue = parseFloat(lastSlider.value);
                lastSlider.value = (lastSliderValue + (100 - finalSum)).toFixed(1);
            }

            // Update all displayed values for the current question
            slidersArray.forEach((slider, i) => {
                valuesForQuestion[i].textContent = `${parseFloat(slider.value).toFixed(2)}%`;
            });
        }


        // Helper function for Kullback-Leibler Divergence
        function klDivergence(p, q) {
            let divergence = 0;
            for (let i = 0; i < p.length; i++) {
                const pi = p[i];
                const qi = q[i];

                if (pi === 0) {
                    // If p_i is 0, the term p_i * log(p_i / q_i) is 0.
                    continue;
                }
                if (qi === 0) {
                    // If p_i > 0 and q_i = 0, KL divergence is infinite.
                    return Infinity;
                }
                // Both pi and qi are guaranteed to be > 0 here
                divergence += pi * Math.log2(pi / qi);
            }
            return divergence;
        }

        // Jensen-Shannon Divergence
        function jensenShannonDivergence(p, q) {
            const m = p.map((pi, i) => (pi + q[i]) / 2);
            const jsd = (klDivergence(p, m) + klDivergence(q, m)) / 2;
            return jsd;
        }

        function calculateScore(guess, correct) {
            // Using Jensen-Shannon Divergence, transformed to be between 0 and 1 (higher is better)
            const jsd = jensenShannonDivergence(guess, correct);
            // Max JSD with log base 2 is 1. So, 1 - JSD will give a score from 0 to 1, where 1 is perfect.
            const score = 1 - jsd;
            return score.toFixed(4);
        }
    
        function submitGuess(qIndex) {
            const slidersForQuestion = document.querySelectorAll(`input[type="range"][data-question-index="${qIndex}"]`);
            let userGuessPercentages = [];
            let sum = 0;
            const errorMessage = document.getElementById(`error-message-${qIndex}`);
            errorMessage.style.display = 'none';

            slidersForQuestion.forEach(slider => {
                const value = parseFloat(slider.value);
                userGuessPercentages.push(value);
                sum += value;
            });

            if (Math.abs(sum - 100) > 0.01) { // Allow for minor floating point inaccuracies
                errorMessage.textContent = `Your probabilities for this question sum to ${sum.toFixed(2)}%. They must sum to 100%.`;
                errorMessage.style.display = 'block';
                return;
            }

            const userGuess = userGuessPercentages.map(p => p / 100); // Convert to probabilities
            const questionData = quizData[qIndex];
            const score = calculateScore(userGuess, questionData.correctDistribution);

            document.getElementById(`your-guess-${qIndex}`).textContent = userGuessPercentages.map(p => `${p.toFixed(2)}%`).join(', ');
            document.getElementById(`correct-distribution-${qIndex}`).textContent = questionData.correctDistribution.map(p => `${(p * 100).toFixed(2)}%`).join(', ');
            document.getElementById(`score-value-${qIndex}`).textContent = score;
            document.getElementById(`score-display-${qIndex}`).style.display = 'block';
        }
    </script>
</body>
</html>
